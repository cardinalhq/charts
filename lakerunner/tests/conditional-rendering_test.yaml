suite: test conditional rendering
values:
  - ../values.yaml
set:
  cloudProvider.aws.region: us-west-2
templates:
  - setup-job.yaml
  - query-api-v2-deployment.yaml
  - query-worker-v2-deployment.yaml
  - grafana-deployment.yaml
  - ingest-logs-deployment.yaml
  - ingest-metrics-deployment.yaml
  - compact-logs-deployment.yaml
  - compact-metrics-deployment.yaml
  - rollup-metrics-deployment.yaml
  - boxer-deployment.yaml
  - sweeper-deployment.yaml
  - pubsub-http-deployment.yaml
  - pubsub-sqs-deployment.yaml
  - pubsub-gcp-deployment.yaml
tests:
  - it: should render setup job when enabled
    set:
      setup.enabled: true
    templates:
      - setup-job.yaml
    asserts:
      - isKind:
          of: Job

  - it: should not render setup job when disabled
    set:
      setup.enabled: false
    templates:
      - setup-job.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render query api when enabled
    set:
      queryApi.enabled: true
    templates:
      - query-api-v2-deployment.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should not render query api when disabled
    set:
      queryApi.enabled: false
    templates:
      - query-api-v2-deployment.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render query worker when enabled
    set:
      queryWorker.enabled: true
    templates:
      - query-worker-v2-deployment.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should not render query worker when disabled
    set:
      queryWorker.enabled: false
    templates:
      - query-worker-v2-deployment.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render grafana when enabled
    set:
      grafana.enabled: true
    templates:
      - grafana-deployment.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should not render grafana when disabled
    set:
      grafana.enabled: false
    templates:
      - grafana-deployment.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render pubsub http when enabled
    set:
      pubsub.HTTP.enabled: true
    templates:
      - pubsub-http-deployment.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should not render pubsub http when disabled
    set:
      pubsub.HTTP.enabled: false
    templates:
      - pubsub-http-deployment.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render pubsub sqs when enabled
    set:
      pubsub.SQS.enabled: true
      pubsub.SQS.queueURL: "https://sqs.us-east-2.amazonaws.com/123456789012/test-queue"
      pubsub.SQS.region: "us-east-2"
    templates:
      - pubsub-sqs-deployment.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should not render pubsub sqs when disabled
    set:
      pubsub.SQS.enabled: false
    templates:
      - pubsub-sqs-deployment.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render GCP pubsub when enabled
    set:
      pubsub.GCP.enabled: true
      pubsub.GCP.projectID: "test-project"
      pubsub.GCP.subscriptionID: "test-subscription"
    templates:
      - pubsub-gcp-deployment.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should not render GCP pubsub when disabled
    set:
      pubsub.GCP.enabled: false
    templates:
      - pubsub-gcp-deployment.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should render all ingest and processing components when enabled
    set:
      ingestLogs.enabled: true
      ingestMetrics.enabled: true
      compactLogs.enabled: true
      compactMetrics.enabled: true
      rollupMetrics.enabled: true
      sweeper.enabled: true
    templates:
      - ingest-logs-deployment.yaml
      - ingest-metrics-deployment.yaml
      - compact-logs-deployment.yaml
      - compact-metrics-deployment.yaml
      - rollup-metrics-deployment.yaml
      - boxer-deployment.yaml
      - sweeper-deployment.yaml
    asserts:
      - isKind:
          of: Deployment

