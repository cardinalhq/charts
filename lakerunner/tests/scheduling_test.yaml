suite: test basic scheduling functionality
templates:
  - ingest-logs-deployment.yaml
  - query-worker-deployment.yaml
  - grafana-deployment.yaml
tests:
  - it: should not render scheduling when not configured
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - notExists:
          path: spec.template.spec.nodeSelector
      - notExists:
          path: spec.template.spec.tolerations
      - notExists:
          path: spec.template.spec.affinity

  - it: should render global nodeSelector
    set:
      global.nodeSelector:
        disktype: ssd
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should render component nodeSelector overriding global
    set:
      global.nodeSelector:
        disktype: ssd
        region: us-west
      queryWorker.nodeSelector:
        disktype: nvme
        workload: query
    templates:
      - query-worker-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: nvme
      - equal:
          path: spec.template.spec.nodeSelector.region
          value: us-west
      - equal:
          path: spec.template.spec.nodeSelector.workload
          value: query

  - it: should apply grafana scheduling
    set:
      grafana.enabled: true
      grafana.nodeSelector:
        ui-node: "true"
    templates:
      - grafana-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.ui-node
          value: "true"