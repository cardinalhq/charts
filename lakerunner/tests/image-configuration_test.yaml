suite: test image configuration
values:
  - ./test-values.yaml
templates:
  - setup-job.yaml
  - query-api-statefulset.yaml
  - query-worker-deployment.yaml
  - grafana-deployment.yaml
  - ingest-logs-deployment.yaml
  - compact-logs-deployment.yaml
tests:
  - it: should use appVersion as default tag for lakerunner components
    templates:
      - setup-job.yaml
      - ingest-logs-deployment.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "public.ecr.aws/cardinalhq.io/lakerunner.*:v[0-9]+\.[0-9]+\.[0-9]+.*$"

  - it: should override with global tag
    set:
      global.image.tag: "v1.2.3"
    templates:
      - setup-job.yaml
      - ingest-logs-deployment.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":v1.2.3$"

  - it: should use component-specific tag when set
    set:
      setup.image.tag: "v2.0.0"
      global.image.tag: "v1.2.3"
    templates:
      - setup-job.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":v2.0.0$"

  - it: should use correct repository paths for different components
    templates:
      - query-api-statefulset.yaml
    set:
      queryApi.enabled: true
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "^public.ecr.aws/cardinalhq.io/lakerunner/query-api-v2:v[0-9]+\.[0-9]+\.[0-9]+.*$"

  - it: should use versioned tags for query components
    templates:
      - query-api-statefulset.yaml
      - query-worker-deployment.yaml
    set:
      queryApi.enabled: true
      queryWorker.enabled: true
    asserts:
      - template: query-api-statefulset.yaml
        matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":v[0-9]+\.[0-9]+\.[0-9]+.*$"
      - template: query-worker-deployment.yaml
        matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":v[0-9]+\.[0-9]+\.[0-9]+.*$"

  - it: should handle external images correctly
    templates:
      - grafana-deployment.yaml
    set:
      grafana.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "grafana/grafana:latest"

  - it: should use default pullPolicy from global config
    templates:
      - setup-job.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "IfNotPresent"

  - it: should override pullPolicy when component specifies it
    set:
      setup.image.pullPolicy: "IfNotPresent"
    templates:
      - setup-job.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "IfNotPresent"

  - it: should use global pullPolicy across all components
    set:
      global.image.pullPolicy: "Never"
    templates:
      - setup-job.yaml
      - ingest-logs-deployment.yaml
      - compact-logs-deployment.yaml
    asserts:
      - template: setup-job.yaml
        equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Never"
      - template: ingest-logs-deployment.yaml
        equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Never"
      - template: compact-logs-deployment.yaml
        equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "Never"

  - it: should prioritize component pullPolicy over global pullPolicy
    set:
      global.image.pullPolicy: "Always"
      setup.image.pullPolicy: "IfNotPresent"
    templates:
      - setup-job.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "IfNotPresent"

  - it: should apply global pullPolicy to external images
    set:
      global.image.pullPolicy: "IfNotPresent"
      grafana.enabled: true
    templates:
      - grafana-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: "IfNotPresent"