suite: test scaling configuration
templates:
  - query-api-v2-deployment.yaml
  - ingest-logs-deployment.yaml
  - ingest-logs-scaledobject.yaml
  - ingest-traces-deployment.yaml
  - ingest-traces-scaledobject.yaml
  - compact-logs-deployment.yaml
  - compact-logs-scaledobject.yaml
  - compact-traces-deployment.yaml
  - compact-traces-scaledobject.yaml
  - boxer-rollup-metrics-deployment.yaml
  - boxer-rollup-metrics-scaledobject.yaml
values:
  - ../values.yaml
set:
  cloudProvider.aws.region: us-west-2
  queryApi.enabled: true
  queryWorker.enabled: true
tests:
  - it: should set correct replicas for query api
    set:
      queryApi.enabled: true
      queryApi.replicas: 3
    templates:
      - query-api-v2-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should set correct replicas for ingest logs when autoscaling disabled
    set:
      ingestLogs.enabled: true
      ingestLogs.replicas: 5
      ingestLogs.autoscaling.enabled: false
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  - it: should not set replicas when KEDA autoscaling is active
    set:
      global.autoscaling.mode: keda
      monitoring.enabled: true
      ingestLogs.enabled: true
      ingestLogs.autoscaling.enabled: true
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should fail deployment when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: true
      ingestMetrics.enabled: false
      ingestTraces.enabled: false
      compactLogs.enabled: false
      compactMetrics.enabled: false
      compactTraces.enabled: false
      rollupMetrics.enabled: false
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"

  - it: should set correct termination grace periods
    set:
      ingestLogs.enabled: true
      ingestLogs.terminationGracePeriodSeconds: 900
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.terminationGracePeriodSeconds
          value: 900

  # KEDA Scaling Tests
  - it: should create ScaledObject when KEDA mode is enabled
    set:
      global.autoscaling.mode: keda
      ingestLogs.enabled: true
      monitoring.enabled: true
      ingestLogs.autoscaling.minReplicas: 1
      ingestLogs.autoscaling.maxReplicas: 10
    templates:
      - ingest-logs-scaledobject.yaml
    asserts:
      - isKind:
          of: ScaledObject
      - equal:
          path: spec.minReplicaCount
          value: 1
      - equal:
          path: spec.maxReplicaCount
          value: 10
      - equal:
          path: spec.triggers[0].type
          value: "external"
      - equal:
          path: spec.triggers[0].metadata.serviceType
          value: "ingest-logs"

  - it: should not create ScaledObject when disabled mode is set
    set:
      global.autoscaling.mode: disabled
      ingestLogs.enabled: true
    templates:
      - ingest-logs-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0


  - it: should support per-component scaling disable
    set:
      global.autoscaling.mode: keda
      monitoring.enabled: true
      ingestLogs.enabled: true
      ingestLogs.autoscaling.enabled: false
    templates:
      - ingest-logs-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should not set replicas when KEDA scaling is enabled
    set:
      global.autoscaling.mode: keda
      ingestLogs.enabled: true
      ingestLogs.replicas: 5
      monitoring.enabled: true
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should set replicas when scaling is disabled
    set:
      global.autoscaling.mode: disabled
      ingestLogs.enabled: true
      ingestLogs.replicas: 5
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  # Traces component tests
  - it: should set correct replicas for ingest traces when autoscaling disabled
    set:
      ingestTraces.enabled: true
      ingestTraces.replicas: 4
      ingestTraces.autoscaling.enabled: false
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 4

  - it: should not set replicas for traces when KEDA autoscaling is active
    set:
      global.autoscaling.mode: keda
      monitoring.enabled: true
      ingestTraces.enabled: true
      ingestTraces.autoscaling.enabled: true
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should fail deployment for traces when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: false
      ingestMetrics.enabled: false
      ingestTraces.enabled: true
      compactLogs.enabled: false
      compactMetrics.enabled: false
      compactTraces.enabled: false
      rollupMetrics.enabled: false
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"

  - it: should set correct termination grace periods for traces
    set:
      ingestTraces.enabled: true
      ingestTraces.terminationGracePeriodSeconds: 600
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.terminationGracePeriodSeconds
          value: 600

  - it: should create ScaledObject for traces when KEDA mode is enabled
    set:
      global.autoscaling.mode: keda
      ingestTraces.enabled: true
      monitoring.enabled: true
      ingestTraces.autoscaling.minReplicas: 2
      ingestTraces.autoscaling.maxReplicas: 12
    templates:
      - ingest-traces-scaledobject.yaml
    asserts:
      - isKind:
          of: ScaledObject
      - equal:
          path: spec.minReplicaCount
          value: 2
      - equal:
          path: spec.maxReplicaCount
          value: 12
      - equal:
          path: spec.triggers[0].type
          value: "external"
      - equal:
          path: spec.triggers[0].metadata.serviceType
          value: "ingest-traces"

  - it: should not create ScaledObject for traces when disabled mode is set
    set:
      global.autoscaling.mode: disabled
      ingestTraces.enabled: true
    templates:
      - ingest-traces-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should support per-component scaling disable for traces
    set:
      global.autoscaling.mode: keda
      monitoring.enabled: true
      ingestTraces.enabled: true
      ingestTraces.autoscaling.enabled: false
    templates:
      - ingest-traces-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should not set replicas for traces when KEDA scaling is enabled
    set:
      global.autoscaling.mode: keda
      ingestTraces.enabled: true
      ingestTraces.replicas: 4
      monitoring.enabled: true
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should set replicas for traces when scaling is disabled
    set:
      global.autoscaling.mode: disabled
      ingestTraces.enabled: true
      ingestTraces.replicas: 6
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 6

  # Compact component tests
  - it: should fail deployment for compact-logs when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: false
      ingestMetrics.enabled: false
      ingestTraces.enabled: false
      compactLogs.enabled: true
      compactMetrics.enabled: false
      compactTraces.enabled: false
      rollupMetrics.enabled: false
    templates:
      - compact-logs-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"

  - it: should fail deployment for compact-traces when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: false
      ingestMetrics.enabled: false
      ingestTraces.enabled: false
      compactLogs.enabled: false
      compactMetrics.enabled: false
      compactTraces.enabled: true
      rollupMetrics.enabled: false
    templates:
      - compact-traces-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"

  # Boxer Rollup Metrics component tests
  - it: should set correct replicas for boxer rollup metrics when autoscaling disabled
    set:
      boxerRollupMetrics.enabled: true
      boxerRollupMetrics.replicas: 3
      boxerRollupMetrics.autoscaling.enabled: false
    templates:
      - boxer-rollup-metrics-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should not set replicas for boxer rollup metrics when KEDA autoscaling is active
    set:
      global.autoscaling.mode: keda
      monitoring.enabled: true
      boxerRollupMetrics.enabled: true
      boxerRollupMetrics.autoscaling.enabled: true
    templates:
      - boxer-rollup-metrics-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should create ScaledObject for boxer rollup metrics when KEDA mode is enabled
    set:
      global.autoscaling.mode: keda
      boxerRollupMetrics.enabled: true
      monitoring.enabled: true
      boxerRollupMetrics.autoscaling.minReplicas: 2
      boxerRollupMetrics.autoscaling.maxReplicas: 15
    templates:
      - boxer-rollup-metrics-scaledobject.yaml
    asserts:
      - isKind:
          of: ScaledObject
      - equal:
          path: spec.minReplicaCount
          value: 2
      - equal:
          path: spec.maxReplicaCount
          value: 15
      - equal:
          path: spec.triggers[0].type
          value: "external"
      - equal:
          path: spec.triggers[0].metadata.serviceType
          value: "boxer-rollup-metrics"

  - it: should not create ScaledObject for boxer rollup metrics when disabled mode is set
    set:
      global.autoscaling.mode: disabled
      boxerRollupMetrics.enabled: true
    templates:
      - boxer-rollup-metrics-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should fail deployment for boxer rollup metrics when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: false
      ingestMetrics.enabled: false
      ingestTraces.enabled: false
      compactLogs.enabled: false
      compactMetrics.enabled: false
      compactTraces.enabled: false
      rollupMetrics.enabled: false
      boxerRollupMetrics.enabled: true
    templates:
      - boxer-rollup-metrics-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"