suite: test scaling configuration
templates:
  - query-api-statefulset.yaml
  - ingest-logs-deployment.yaml
  - ingest-logs-scaledobject.yaml
  - ingest-traces-deployment.yaml
  - ingest-traces-scaledobject.yaml
  - compact-logs-deployment.yaml
  - compact-logs-scaledobject.yaml
  - compact-traces-deployment.yaml
  - compact-traces-scaledobject.yaml
  - keda-auth.yaml
values:
  - ../values.yaml
set:
  aws.region: us-west-2
  queryApi.enabled: true
  queryWorker.enabled: true
tests:
  - it: should set correct replicas for query api
    set:
      queryApi.enabled: true
      queryApi.replicas: 3
    templates:
      - query-api-statefulset.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should set correct replicas for ingest logs when autoscaling disabled
    set:
      ingestLogs.enabled: true
      ingestLogs.replicas: 5
      ingestLogs.autoscaling.enabled: false
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  - it: should not set replicas when KEDA autoscaling is active
    set:
      global.autoscaling.mode: keda
      database.lrdb.host: postgres.example.com
      ingestLogs.enabled: true
      ingestLogs.autoscaling.enabled: true
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should fail deployment when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: true
      ingestMetrics.enabled: false
      ingestTraces.enabled: false
      compactLogs.enabled: false
      compactMetrics.enabled: false
      compactTraces.enabled: false
      rollupMetrics.enabled: false
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"

  - it: should set correct termination grace periods
    set:
      ingestLogs.enabled: true
      ingestLogs.terminationGracePeriodSeconds: 900
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.terminationGracePeriodSeconds
          value: 900

  # KEDA Scaling Tests
  - it: should create ScaledObject when KEDA mode is enabled
    set:
      global.autoscaling.mode: keda
      ingestLogs.enabled: true
      database.lrdb.host: postgres.example.com
      ingestLogs.autoscaling.minReplicas: 1
      ingestLogs.autoscaling.maxReplicas: 10
      ingestLogs.autoscaling.keda.targetQueueDepth: 100
    templates:
      - ingest-logs-scaledobject.yaml
    asserts:
      - isKind:
          of: ScaledObject
      - equal:
          path: spec.minReplicaCount
          value: 1
      - equal:
          path: spec.maxReplicaCount
          value: 10
      - equal:
          path: spec.triggers[0].metadata.targetQueryValue
          value: "100"

  - it: should not create ScaledObject when disabled mode is set
    set:
      global.autoscaling.mode: disabled
      ingestLogs.enabled: true
    templates:
      - ingest-logs-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create TriggerAuthentication when KEDA is enabled
    set:
      global.autoscaling.mode: keda
      database.lrdb.host: postgres.example.com
    templates:
      - keda-auth.yaml
    asserts:
      - isKind:
          of: TriggerAuthentication
      - equal:
          path: metadata.name
          value: RELEASE-NAME-lakerunner-keda-auth

  - it: should not create TriggerAuthentication when KEDA is disabled
    set:
      global.autoscaling.mode: disabled
    templates:
      - keda-auth.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should support per-component scaling disable
    set:
      global.autoscaling.mode: keda
      database.lrdb.host: postgres.example.com
      ingestLogs.enabled: true
      ingestLogs.autoscaling.enabled: false
    templates:
      - ingest-logs-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should not set replicas when KEDA scaling is enabled
    set:
      global.autoscaling.mode: keda
      ingestLogs.enabled: true
      ingestLogs.replicas: 5
      database.lrdb.host: postgres.example.com
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should set replicas when scaling is disabled
    set:
      global.autoscaling.mode: disabled
      ingestLogs.enabled: true
      ingestLogs.replicas: 5
    templates:
      - ingest-logs-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  # Traces component tests
  - it: should set correct replicas for ingest traces when autoscaling disabled
    set:
      ingestTraces.enabled: true
      ingestTraces.replicas: 4
      ingestTraces.autoscaling.enabled: false
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 4

  - it: should not set replicas for traces when KEDA autoscaling is active
    set:
      global.autoscaling.mode: keda
      database.lrdb.host: postgres.example.com
      ingestTraces.enabled: true
      ingestTraces.autoscaling.enabled: true
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should fail deployment for traces when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: false
      ingestMetrics.enabled: false
      ingestTraces.enabled: true
      compactLogs.enabled: false
      compactMetrics.enabled: false
      compactTraces.enabled: false
      rollupMetrics.enabled: false
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"

  - it: should set correct termination grace periods for traces
    set:
      ingestTraces.enabled: true
      ingestTraces.terminationGracePeriodSeconds: 600
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.terminationGracePeriodSeconds
          value: 600

  - it: should create ScaledObject for traces when KEDA mode is enabled
    set:
      global.autoscaling.mode: keda
      ingestTraces.enabled: true
      database.lrdb.host: postgres.example.com
      ingestTraces.autoscaling.minReplicas: 2
      ingestTraces.autoscaling.maxReplicas: 12
      ingestTraces.autoscaling.keda.targetQueueDepth: 50
    templates:
      - ingest-traces-scaledobject.yaml
    asserts:
      - isKind:
          of: ScaledObject
      - equal:
          path: spec.minReplicaCount
          value: 2
      - equal:
          path: spec.maxReplicaCount
          value: 12
      - equal:
          path: spec.triggers[0].metadata.targetQueryValue
          value: "50"
      - equal:
          path: spec.triggers[0].metadata.query
          value: "SELECT COALESCE(COUNT(*), 0) FROM inqueue WHERE telemetry_type='traces' AND claimed_at IS NULL"

  - it: should not create ScaledObject for traces when disabled mode is set
    set:
      global.autoscaling.mode: disabled
      ingestTraces.enabled: true
    templates:
      - ingest-traces-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should support per-component scaling disable for traces
    set:
      global.autoscaling.mode: keda
      database.lrdb.host: postgres.example.com
      ingestTraces.enabled: true
      ingestTraces.autoscaling.enabled: false
    templates:
      - ingest-traces-scaledobject.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should not set replicas for traces when KEDA scaling is enabled
    set:
      global.autoscaling.mode: keda
      ingestTraces.enabled: true
      ingestTraces.replicas: 4
      database.lrdb.host: postgres.example.com
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should set replicas for traces when scaling is disabled
    set:
      global.autoscaling.mode: disabled
      ingestTraces.enabled: true
      ingestTraces.replicas: 6
    templates:
      - ingest-traces-deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 6

  # Compact component tests
  - it: should fail deployment for compact-logs when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: false
      ingestMetrics.enabled: false
      ingestTraces.enabled: false
      compactLogs.enabled: true
      compactMetrics.enabled: false
      compactTraces.enabled: false
      rollupMetrics.enabled: false
    templates:
      - compact-logs-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"

  - it: should fail deployment for compact-traces when HPA mode is used
    set:
      global.autoscaling.mode: hpa
      ingestLogs.enabled: false
      ingestMetrics.enabled: false
      ingestTraces.enabled: false
      compactLogs.enabled: false
      compactMetrics.enabled: false
      compactTraces.enabled: true
      rollupMetrics.enabled: false
    templates:
      - compact-traces-deployment.yaml
    asserts:
      - failedTemplate:
          errorPattern: "HPA scaling mode is no longer supported"