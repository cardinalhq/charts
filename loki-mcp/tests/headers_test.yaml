suite: test loki headers configuration
templates:
  - deployment.yaml
tests:
  - it: should render LOKI_URL environment variable
    set:
      loki.url: "http://loki.example.com:3100"
      cardinal.apiKey: "test-key"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: LOKI_URL
      - equal:
          path: spec.template.spec.containers[0].env[0].value
          value: "http://loki.example.com:3100"

  - it: should render LOKI_HEADER_* environment variables when headers are provided
    set:
      loki.url: "http://loki.example.com:3100"
      loki.headers:
        X-Scope-OrgID: "tenant-123"
        Authorization: "Bearer my-token"
      cardinal.apiKey: "test-key"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_X_SCOPE_ORGID
            value: "tenant-123"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_AUTHORIZATION
            value: "Bearer my-token"

  - it: should not render LOKI_HEADER_* variables when headers are empty
    set:
      loki.url: "http://loki.example.com:3100"
      loki.headers: {}
      cardinal.apiKey: "test-key"
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_X_SCOPE_ORGID
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_AUTHORIZATION

  - it: should convert header names to uppercase with underscores
    set:
      loki.url: "http://loki.example.com:3100"
      loki.headers:
        X-Custom-Header: "custom-value"
        content-type: "application/json"
      cardinal.apiKey: "test-key"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_X_CUSTOM_HEADER
            value: "custom-value"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_CONTENT_TYPE
            value: "application/json"

  - it: should render multiple headers correctly
    set:
      loki.url: "http://loki.example.com:3100"
      loki.headers:
        X-Scope-OrgID: "tenant-456"
        Authorization: "Bearer token-xyz"
        X-Custom-Field: "value123"
      cardinal.apiKey: "test-key"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_X_SCOPE_ORGID
            value: "tenant-456"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_AUTHORIZATION
            value: "Bearer token-xyz"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_HEADER_X_CUSTOM_FIELD
            value: "value123"

  - it: should not render LOKI_USE_HTTPS environment variable
    set:
      loki.url: "https://loki.example.com:3100"
      cardinal.apiKey: "test-key"
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOKI_USE_HTTPS
